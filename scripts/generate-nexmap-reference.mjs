import fs from "node:fs";
import path from "node:path";
import vm from "node:vm";

const root = path.resolve(process.cwd());
const nexmapRoot = path.resolve(root, "..", "nexmap3");
const outDir = path.join(root, "docs", "nexMap", "reference");

const source = path.join(nexmapRoot, "src", "base", "helpertables.js");

const banner =
  "<!-- This file is generated by scripts/generate-nexmap-reference.mjs. -->\n\n";

const escapeCell = (value) => {
  if (value === null || typeof value === "undefined") return "";
  return String(value).replace(/\|/g, "\\|").replace(/\n/g, " ");
};

const sanitizeModule = (code) =>
  code
    .replace(/import[^;]+;\s*/g, "")
    .replace(/export\s+\{[^}]+\};?/g, "")
    .replace(/export\s+const\s+/g, "const ")
    .replace(/export\s+default\s+/g, "const __default__ = ");

const loadVars = (filePath, names) => {
  const code = fs.readFileSync(filePath, "utf8");
  const exportShim =
    "globalThis.__nexmap_exports = globalThis.__nexmap_exports || {};\n" +
    names
      .map(
        (name) =>
          `globalThis.__nexmap_exports["${name}"] = typeof ${name} !== "undefined" ? ${name} : undefined;`
      )
      .join("\n");

  const context = {
    console,
    globalThis: {},
  };
  vm.createContext(context);
  vm.runInContext(`${sanitizeModule(code)}\n${exportShim}`, context, {
    filename: filePath,
  });
  const exports = context.globalThis.__nexmap_exports || {};
  return Object.fromEntries(names.map((name) => [name, exports[name]]));
};

const ensureDir = (dir) => {
  fs.mkdirSync(dir, { recursive: true });
};

const writeFile = (filePath, content) => {
  fs.writeFileSync(filePath, content, "utf8");
  console.log(`[nexMap] wrote ${path.relative(root, filePath)}`);
};

const buildTravelReference = (data) => {
  const universeRooms = data.universeRooms || {};
  const clioRooms = data.clioRooms || {};
  const etherChannelRooms = data.etherChannelRooms || {};
  const urnMounts = data.urnMounts || {};
  const gareExits = data.gareExits || {};
  const knockerExitsMain = data.knockerExitsMain || [];
  const knockerExitsMeropis = data.knockerExitsMeropis || [];

  let body = "---\ntitle: Travel Reference\n---\n\n";
  body += banner;
  body += "Reference tables for nexMap travel options.\n\n";

  body += "## Universe tarot rooms (Main)\n\n";
  body += "| Room ID | Keyword |\n| --- | --- |\n";
  Object.entries(universeRooms.main || {})
    .sort(([a], [b]) => Number(a) - Number(b))
    .forEach(([roomId, keyword]) => {
      body += `| ${escapeCell(roomId)} | ${escapeCell(keyword)} |\n`;
    });

  body += "\n## Universe tarot rooms (Meropis)\n\n";
  body += "| Room ID | Keyword |\n| --- | --- |\n";
  Object.entries(universeRooms.meropis || {})
    .sort(([a], [b]) => Number(a) - Number(b))
    .forEach(([roomId, keyword]) => {
      body += `| ${escapeCell(roomId)} | ${escapeCell(keyword)} |\n`;
    });

  body += "\n## Clio rooms\n\n";
  body += "| Room ID | Name |\n| --- | --- |\n";
  Object.entries(clioRooms)
    .sort(([a], [b]) => Number(a) - Number(b))
    .forEach(([roomId, name]) => {
      body += `| ${escapeCell(roomId)} | ${escapeCell(name)} |\n`;
    });

  body += "\n## Ether channel rooms\n\n";
  body += "| Room ID | Area |\n| --- | --- |\n";
  Object.entries(etherChannelRooms)
    .sort(([a], [b]) => Number(a) - Number(b))
    .forEach(([roomId, area]) => {
      body += `| ${escapeCell(roomId)} | ${escapeCell(area)} |\n`;
    });

  body += "\n## Urn mounts\n\n";
  body += "| Mount | Room ID |\n| --- | --- |\n";
  Object.entries(urnMounts)
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([mount, roomId]) => {
      body += `| ${escapeCell(mount)} | ${escapeCell(roomId)} |\n`;
    });

  body += "\n## Gare exits\n\n";
  body += "| Area | Room ID |\n| --- | --- |\n";
  Object.entries(gareExits)
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([area, roomId]) => {
      body += `| ${escapeCell(area)} | ${escapeCell(roomId)} |\n`;
    });

  body += "\n## Knocker exits (Main)\n\n";
  body += "| Direction | Target room | Area |\n| --- | --- | --- |\n";
  knockerExitsMain.forEach((exit) => {
    body += `| ${escapeCell(exit.dir)} | ${escapeCell(
      exit.target
    )} | ${escapeCell(exit.areaName)} |\n`;
  });

  body += "\n## Knocker exits (Meropis)\n\n";
  body += "| Direction | Target room | Area |\n| --- | --- | --- |\n";
  knockerExitsMeropis.forEach((exit) => {
    body += `| ${escapeCell(exit.dir)} | ${escapeCell(
      exit.target
    )} | ${escapeCell(exit.areaName)} |\n`;
  });

  return body;
};

const buildDirectionReference = (data) => {
  const shortDirs = data.shortDirs || {};
  const longDirs = data.longDirs || {};

  let body = "---\ntitle: Direction Reference\n---\n\n";
  body += banner;
  body += "Direction mapping used by nexMap to normalize exits.\n\n";

  body += "## Short to long\n\n";
  body += "| Short | Long |\n| --- | --- |\n";
  Object.entries(shortDirs)
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([shortDir, longDir]) => {
      body += `| ${escapeCell(shortDir)} | ${escapeCell(longDir)} |\n`;
    });

  body += "\n## Long to short\n\n";
  body += "| Long | Short |\n| --- | --- |\n";
  Object.entries(longDirs)
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([longDir, shortDir]) => {
      body += `| ${escapeCell(longDir)} | ${escapeCell(shortDir)} |\n`;
    });

  return body;
};

const buildEnvironmentReference = (data) => {
  const environments = data.environments || {};

  let body = "---\ntitle: Environment Codes\n---\n\n";
  body += banner;
  body += "Crowdmap environment codes used for room styling.\n\n";

  body += "| Environment | Code |\n| --- | --- |\n";
  Object.entries(environments)
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([name, code]) => {
      body += `| ${escapeCell(name)} | ${escapeCell(code)} |\n`;
    });

  return body;
};

const buildAreaReference = (data) => {
  const areaContinents = data.areaContinents || {};

  let body = "---\ntitle: Area Continents\n---\n\n";
  body += banner;
  body += "Crowdmap area IDs grouped by continent.\n\n";

  Object.entries(areaContinents)
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([continent, areas]) => {
      const list = Array.isArray(areas) ? areas.join(", ") : "";
      body += `## ${escapeCell(continent)}\n\n${escapeCell(list)}\n\n`;
    });

  return body;
};

const main = () => {
  ensureDir(outDir);

  const data = loadVars(source, [
    "universeRooms",
    "clioRooms",
    "etherChannelRooms",
    "urnMounts",
    "gareExits",
    "knockerExitsMain",
    "knockerExitsMeropis",
    "shortDirs",
    "longDirs",
    "areaContinents",
    "environments",
  ]);

  writeFile(path.join(outDir, "travel.mdx"), buildTravelReference(data));
  writeFile(
    path.join(outDir, "directions.mdx"),
    buildDirectionReference(data)
  );
  writeFile(
    path.join(outDir, "environments.mdx"),
    buildEnvironmentReference(data)
  );
  writeFile(path.join(outDir, "areas.mdx"), buildAreaReference(data));
};

main();
