import fs from "node:fs";
import path from "node:path";
import vm from "node:vm";

const root = path.resolve(process.cwd());
const nexsysRoot = path.resolve(root, "..", "nexsys3");
const outDir = path.join(root, "docs", "nexSys", "reference");

const sources = {
  affTable: path.join(nexsysRoot, "src", "base", "affs", "affTable.js"),
  defTable: path.join(nexsysRoot, "src", "base", "defs", "defTable.js"),
  balanceTable: path.join(
    nexsysRoot,
    "src",
    "base",
    "balances",
    "balanceTable.js"
  ),
  cureTable: path.join(nexsysRoot, "src", "base", "cures", "cureTable.js"),
  cacheTable: path.join(
    nexsysRoot,
    "src",
    "base",
    "cache",
    "cacheTable.js"
  ),
};

const banner =
  "<!-- This file is generated by scripts/generate-nexsys-reference.mjs. -->\n\n";

const escapeCell = (value) => {
  if (value === null || typeof value === "undefined") return "";
  return String(value).replace(/\|/g, "\\|").replace(/\n/g, " ");
};

const formatArray = (value, joiner = ", ") => {
  if (!Array.isArray(value)) return escapeCell(value);
  return escapeCell(value.join(joiner));
};

const formatBlocks = (blocks) => {
  if (!Array.isArray(blocks) || blocks.length === 0) return "";
  const formatted = blocks.map((block) => {
    if (Array.isArray(block)) {
      return block.join(" + ");
    }
    return block;
  });
  return escapeCell(formatted.join(", "));
};

const formatCommand = (command) => {
  if (Array.isArray(command)) return escapeCell(command.join(" / "));
  return escapeCell(command || "");
};

const sanitizeModule = (code) =>
  code
    .replace(/import[^;]+;\s*/g, "")
    .replace(/export\s+\{[^}]+\};?/g, "")
    .replace(/export\s+const\s+/g, "const ")
    .replace(/export\s+default\s+/g, "const __default__ = ");

const loadVars = (filePath, names) => {
  const code = fs.readFileSync(filePath, "utf8");
  const exportShim =
    "globalThis.__nexsys_exports = globalThis.__nexsys_exports || {};\n" +
    names
      .map(
        (name) =>
          `globalThis.__nexsys_exports[\"${name}\"] = typeof ${name} !== \"undefined\" ? ${name} : undefined;`
      )
      .join("\n");
  const context = {
    console,
    performance: { now: () => 0 },
    nexusclient: undefined,
    eventStream: { raiseEvent() {}, registerEvent() {}, removeListener() {} },
    nexSys: undefined,
    globalThis: {},
  };
  vm.createContext(context);
  vm.runInContext(`${sanitizeModule(code)}\n${exportShim}`, context, {
    filename: filePath,
  });
  const exports = context.globalThis.__nexsys_exports || {};
  return Object.fromEntries(names.map((name) => [name, exports[name]]));
};

const ensureDir = (dir) => {
  fs.mkdirSync(dir, { recursive: true });
};

const writeFile = (filePath, content) => {
  fs.writeFileSync(filePath, content, "utf8");
  console.log(`[nexSys] wrote ${path.relative(root, filePath)}`);
};

const buildAfflictions = (affTable) => {
  const affList = [...(affTable.list || [])].sort();
  const prioMap = affTable.prios || {};
  const countable = affTable.types?.countable || {};
  const timed = affTable.types?.timed || {};
  const defs = affTable.types?.defs || {};
  const unknown = affTable.types?.unknown || {};
  const uncurable = affTable.types?.uncurable || {};

  const allAffs = Object.keys(prioMap).sort();

  const typeFor = (id) => {
    const base = id.replace(/\d+$/, "");
    const types = [];
    if (defs[base]) types.push("defence");
    if (countable[base]) types.push("countable");
    if (timed[base]) types.push("timed");
    if (unknown[base]) types.push("unknown");
    if (uncurable[base]) types.push("uncurable");
    return types.join(", ");
  };

  const countInfo = (id) => {
    const base = id.replace(/\d+$/, "");
    const data = countable[base];
    if (!data) return "";
    return `${data.min}-${data.max}`;
  };

  const timedInfo = (id) => {
    const base = id.replace(/\d+$/, "");
    const data = timed[base];
    if (!data) return "";
    return `${data.length}`;
  };

  let body = "---\ntitle: Afflictions Reference\n---\n\n";
  body += banner;
  body += "This reference is generated from the nexSys affliction table.\n\n";

  body += "## Affliction list\n\n";
  body += affList.map((aff) => `- ${aff}`).join("\n");
  body += "\n\n";

  body += "## Priority map\n\n";
  body += "| Affliction | Default prio | Type | Count range | Timed length (s) |\n";
  body += "| --- | --- | --- | --- | --- |\n";
  for (const aff of allAffs) {
    body += `| ${escapeCell(aff)} | ${escapeCell(prioMap[aff])} | ${escapeCell(
      typeFor(aff)
    )} | ${escapeCell(countInfo(aff))} | ${escapeCell(timedInfo(aff))} |\n`;
  }

  body += "\n## Countable afflictions\n\n";
  body += "| Affliction | Min | Max |\n| --- | --- | --- |\n";
  for (const [name, data] of Object.entries(countable)) {
    body += `| ${escapeCell(name)} | ${escapeCell(data.min)} | ${escapeCell(
      data.max
    )} |\n`;
  }

  body += "\n## Timed afflictions\n\n";
  body += "| Affliction | Length (s) |\n| --- | --- |\n";
  for (const [name, data] of Object.entries(timed)) {
    body += `| ${escapeCell(name)} | ${escapeCell(data.length)} |\n`;
  }

  body += "\n## Unknown source afflictions\n\n";
  for (const [name, list] of Object.entries(unknown)) {
    body += `- ${escapeCell(name)}: ${escapeCell(list.join(", "))}\n`;
  }

  body += "\n## Uncurable\n\n";
  body += Object.keys(uncurable)
    .sort()
    .map((aff) => `- ${aff}`)
    .join("\n");
  body += "\n";

  return body;
};

const buildDefences = (defTable) => {
  const defs = Object.entries(defTable).sort(([a], [b]) => a.localeCompare(b));

  let body = "---\ntitle: Defences Reference\n---\n\n";
  body += banner;
  body += "This reference is generated from the nexSys defence table.\n\n";

  body +=
    "| Defence | Command | Balances required | Balances used | Blocks | Skills | Serverside | Preempt | Opposites |\n";
  body += "| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n";

  for (const [name, data] of defs) {
    body += `| ${escapeCell(name)} | ${formatCommand(
      data.command
    )} | ${formatArray(data.bals_req)} | ${formatArray(
      data.bals_used
    )} | ${formatBlocks(data.blocks)} | ${formatArray(
      data.skills
    )} | ${escapeCell(data.serverside ?? false)} | ${escapeCell(
      data.preempt ?? false
    )} | ${formatArray(data.opps)} |\n`;
  }

  return body;
};

const buildBalances = (balances) => {
  const rows = Object.entries(balances).sort(([a], [b]) => a.localeCompare(b));

  let body = "---\ntitle: Balances Reference\n---\n\n";
  body += banner;
  body += "This reference is generated from the nexSys balance table.\n\n";

  body += "| Balance | Base length (s) | Aff modifiers |\n";
  body += "| --- | --- | --- |\n";

  for (const [name, data] of rows) {
    const mods = data.aff_modifiers
      ? Object.entries(data.aff_modifiers)
          .map(
            ([aff, mod]) =>
              `${aff} (x${mod.multiplier}, +${mod.offset})`
          )
          .join(", ")
      : "";
    body += `| ${escapeCell(name)} | ${escapeCell(data.length)} | ${escapeCell(
      mods
    )} |\n`;
  }

  return body;
};

const buildCures = (cureTable) => {
  const cures = Object.entries(cureTable).sort(([a], [b]) => a.localeCompare(b));

  let body = "---\ntitle: Cures Reference\n---\n\n";
  body += banner;
  body += "This reference is generated from the nexSys cure table.\n\n";

  body +=
    "| Cure | Command | Balances required | Balances used | Blocks | Order | Skills | Delay (s) |\n";
  body += "| --- | --- | --- | --- | --- | --- | --- | --- |\n";

  for (const [name, data] of cures) {
    body += `| ${escapeCell(name)} | ${formatCommand(
      data.command
    )} | ${formatArray(data.bals_req)} | ${formatArray(
      data.bals_used
    )} | ${formatBlocks(data.blocks)} | ${formatArray(
      data.order
    )} | ${formatArray(data.skills)} | ${escapeCell(
      data.delay ?? ""
    )} |\n`;
  }

  return body;
};

const buildCache = (cacheTableData) => {
  const cacheTable = cacheTableData.cacheTable || {};
  const herbMap = cacheTableData.herb_name_to_herb || {};
  const herbToMineral = cacheTableData.herb_to_mineral || {};
  const mineralToHerb = cacheTableData.mineral_to_herb || {};
  const herbNames = cacheTableData.herb_names || [];
  const mineralNames = cacheTableData.mineral_names || [];
  const herbNamesGroup = cacheTableData.herb_names_group || [];
  const mineralNamesGroup = cacheTableData.mineral_names_group || [];

  let body = "---\ntitle: Cache Reference\n---\n\n";
  body += banner;
  body += "This reference is generated from the nexSys cache table.\n\n";

  body += "## Default cache amounts\n\n";
  body += "| Item | Amount |\n| --- | --- |\n";
  for (const [name, amount] of Object.entries(cacheTable).sort(([a], [b]) => a.localeCompare(b))) {
    body += `| ${escapeCell(name)} | ${escapeCell(amount)} |\n`;
  }

  body += "\n## Herb names\n\n";
  body += herbNames.map((name) => `- ${escapeCell(name)}`).join("\n");
  body += "\n\n## Mineral names\n\n";
  body += mineralNames.map((name) => `- ${escapeCell(name)}`).join("\n");
  body += "\n\n## Herb group names\n\n";
  body += herbNamesGroup.map((name) => `- ${escapeCell(name)}`).join("\n");
  body += "\n\n## Mineral group names\n\n";
  body += mineralNamesGroup.map((name) => `- ${escapeCell(name)}`).join("\n");

  body += "\n\n## Herb name to herb id\n\n";
  body += "| Name | Herb id |\n| --- | --- |\n";
  for (const [name, id] of Object.entries(herbMap).sort(([a], [b]) => a.localeCompare(b))) {
    body += `| ${escapeCell(name)} | ${escapeCell(id)} |\n`;
  }

  body += "\n## Herb to mineral\n\n";
  body += "| Herb | Mineral |\n| --- | --- |\n";
  for (const [herb, mineral] of Object.entries(herbToMineral).sort(([a], [b]) => a.localeCompare(b))) {
    body += `| ${escapeCell(herb)} | ${escapeCell(mineral)} |\n`;
  }

  body += "\n## Mineral to herb\n\n";
  body += "| Mineral | Herb |\n| --- | --- |\n";
  for (const [mineral, herb] of Object.entries(mineralToHerb).sort(([a], [b]) => a.localeCompare(b))) {
    body += `| ${escapeCell(mineral)} | ${escapeCell(herb)} |\n`;
  }

  return body;
};

const main = () => {
  ensureDir(outDir);

  const { affs } = loadVars(sources.affTable, ["affs"]);
  const { defTable } = loadVars(sources.defTable, ["defTable"]);
  const { balances } = loadVars(sources.balanceTable, ["balances"]);
  const { cures } = loadVars(sources.cureTable, ["cures"]);
  const cacheVars = loadVars(sources.cacheTable, [
    "cacheTable",
    "herb_name_to_herb",
    "herb_to_mineral",
    "mineral_to_herb",
    "herb_names",
    "mineral_names",
    "herb_names_group",
    "mineral_names_group",
  ]);

  writeFile(path.join(outDir, "afflictions.mdx"), buildAfflictions(affs));
  writeFile(path.join(outDir, "defences.mdx"), buildDefences(defTable));
  writeFile(path.join(outDir, "balances.mdx"), buildBalances(balances));
  writeFile(path.join(outDir, "cures.mdx"), buildCures(cures));
  writeFile(path.join(outDir, "cache.mdx"), buildCache(cacheVars));
};

main();
