import fs from "node:fs";
import path from "node:path";
import vm from "node:vm";

const root = path.resolve(process.cwd());
const insightRoot = path.resolve(root, "..", "insight3");
const outDir = path.join(root, "docs", "insight", "reference");

const sources = {
  cures: path.join(insightRoot, "src", "base", "factories", "cures.js"),
  affTables: path.join(insightRoot, "src", "base", "affTables.js"),
  defences: path.join(insightRoot, "src", "base", "factories", "defences.js"),
  balances: path.join(insightRoot, "src", "base", "factories", "balances.js"),
};

const banner =
  "<!-- This file is generated by scripts/generate-insight-reference.mjs. -->\n\n";

const escapeCell = (value) => {
  if (value === null || typeof value === "undefined") return "";
  return String(value).replace(/\|/g, "\\|").replace(/\n/g, " ");
};

const formatArray = (value, joiner = ", ") => {
  if (!Array.isArray(value)) return escapeCell(value);
  return escapeCell(value.join(joiner));
};

const formatBlocks = (blocks) => {
  if (!Array.isArray(blocks) || blocks.length === 0) return "";
  const formatted = blocks.map((block) => {
    if (Array.isArray(block)) {
      return block.join(" + ");
    }
    return block;
  });
  return escapeCell(formatted.join(", "));
};

const sanitizeModule = (code) =>
  code
    .replace(/import[^;]+;\s*/g, "")
    .replace(/export\s+\{[^}]+\};?/g, "")
    .replace(/export\s+const\s+/g, "const ")
    .replace(/export\s+default\s+/g, "const __default__ = ");

const loadVars = (filePath, names, contextExtras = {}) => {
  const code = fs.readFileSync(filePath, "utf8");
  const exportShim =
    "globalThis.__insight_exports = globalThis.__insight_exports || {};\n" +
    names
      .map(
        (name) =>
          `globalThis.__insight_exports["${name}"] = typeof ${name} !== "undefined" ? ${name} : undefined;`
      )
      .join("\n");
  const context = {
    console,
    globalThis: {},
    ...contextExtras,
  };
  vm.createContext(context);
  vm.runInContext(`${sanitizeModule(code)}\n${exportShim}`, context, {
    filename: filePath,
  });
  const exports = context.globalThis.__insight_exports || {};
  return Object.fromEntries(names.map((name) => [name, exports[name]]));
};

const ensureDir = (dir) => {
  fs.mkdirSync(dir, { recursive: true });
};

const writeFile = (filePath, content) => {
  fs.writeFileSync(filePath, content, "utf8");
  console.log(`[insight] wrote ${path.relative(root, filePath)}`);
};

const buildAfflictions = ({ affList, timedAffs, countableAffs, herbAffs, salveAffs, smokeAffs, focusAffs }) => {
  let body = "---\ntitle: Afflictions Reference\n---\n\n";
  body += banner;
  body += "Generated tables for insight afflictions and cure categories.\n\n";

  body += "## Affliction list\n\n";
  const affs = Array.isArray(affList) ? [...affList].sort() : [];
  body += affs.map((aff) => `- ${escapeCell(aff)}`).join("\n");
  body += "\n\n";

  body += "## Timed afflictions\n\n";
  body += "| Affliction | Length (s) |\n| --- | --- |\n";
  Object.entries(timedAffs || {})
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([name, data]) => {
      body += `| ${escapeCell(name)} | ${escapeCell(data.length)} |\n`;
    });

  body += "\n## Countable afflictions\n\n";
  body += "| Affliction | Min | Max |\n| --- | --- |\n";
  Object.entries(countableAffs || {})
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([name, data]) => {
      body += `| ${escapeCell(name)} | ${escapeCell(data.min)} | ${escapeCell(
        data.max
      )} |\n`;
    });

  const setToList = (set) =>
    set && typeof set.forEach === "function"
      ? Array.from(set).sort()
      : [];

  body += "\n## Cure category sets\n\n";
  body += "### Herb afflictions\n\n";
  body += setToList(herbAffs).map((aff) => `- ${escapeCell(aff)}`).join("\n");
  body += "\n\n### Salve afflictions\n\n";
  body += setToList(salveAffs).map((aff) => `- ${escapeCell(aff)}`).join("\n");
  body += "\n\n### Smoke afflictions\n\n";
  body += setToList(smokeAffs).map((aff) => `- ${escapeCell(aff)}`).join("\n");
  body += "\n\n### Focus afflictions\n\n";
  body += setToList(focusAffs).map((aff) => `- ${escapeCell(aff)}`).join("\n");
  body += "\n";

  return body;
};

const buildCures = (cureTable) => {
  let body = "---\ntitle: Cures Reference\n---\n\n";
  body += banner;
  body += "Generated table for insight cure definitions.\n\n";

  body +=
    "| Cure | Command | Balances required | Balances used | Blocks | Order | Skills | Delay (s) | Ordered |\n";
  body += "| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n";

  const cures = Object.entries(cureTable || {}).sort(([a], [b]) =>
    a.localeCompare(b)
  );
  for (const [name, data] of cures) {
    body += `| ${escapeCell(name)} | ${escapeCell(data.command || "")} | ${formatArray(
      data.bals_req
    )} | ${formatArray(data.bals_used)} | ${formatBlocks(data.blocks)} | ${formatArray(
      data.order
    )} | ${formatArray(data.skills)} | ${escapeCell(data.delay ?? "")} | ${escapeCell(
      data.ordered ?? false
    )} |\n`;
  }

  return body;
};

const buildDefences = ({ defaultDefs, timedDefs }) => {
  let body = "---\ntitle: Defences Reference\n---\n\n";
  body += banner;
  body += "Default and timed defences used by insight.\n\n";

  body += "## Default defences\n\n";
  body += "| Defence | Default |\n| --- | --- |\n";
  Object.entries(defaultDefs || {})
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([name, have]) => {
      body += `| ${escapeCell(name)} | ${escapeCell(have)} |\n`;
    });

  body += "\n## Timed defences\n\n";
  body += "| Defence | Default | Length (s) |\n| --- | --- | --- |\n";
  Object.entries(timedDefs || {})
    .sort(([a], [b]) => a.localeCompare(b))
    .forEach(([name, data]) => {
      body += `| ${escapeCell(name)} | ${escapeCell(data.have)} | ${escapeCell(
        data.length
      )} |\n`;
    });

  return body;
};

const buildBalances = ({ balList, bufferTime }) => {
  let body = "---\ntitle: Balances Reference\n---\n\n";
  body += banner;
  body += "Balance timers used by insight.\n\n";
  body += `Buffer multiplier: ${escapeCell(bufferTime)}\n\n`;

  body += "| Balance | Duration (s) |\n| --- | --- |\n";
  (balList || []).forEach((bal) => {
    body += `| ${escapeCell(bal.id)} | ${escapeCell(bal.duration)} |\n`;
  });

  return body;
};

const main = () => {
  ensureDir(outDir);

  const { cures } = loadVars(sources.cures, ["cures"]);
  const cureTable = cures || {};

  const affs = loadVars(
    sources.affTables,
    [
      "affList",
      "timedAffs",
      "countableAffs",
      "herbAffs",
      "salveAffs",
      "smokeAffs",
      "focusAffs",
    ],
    { cureTable }
  );

  const defences = loadVars(sources.defences, ["defaultDefs", "timedDefs"]);
  const balances = loadVars(sources.balances, ["balList", "bufferTime"]);

  writeFile(path.join(outDir, "afflictions.mdx"), buildAfflictions(affs));
  writeFile(path.join(outDir, "cures.mdx"), buildCures(cureTable));
  writeFile(path.join(outDir, "defences.mdx"), buildDefences(defences));
  writeFile(path.join(outDir, "balances.mdx"), buildBalances(balances));
};

main();
